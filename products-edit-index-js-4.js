(window.webpackJsonp=window.webpackJsonp||[]).push([[4],[,,,,,,,function(e,t,n){"use strict";n.r(t),n.d(t,"default",(function(){return d}));var i=n(12),s=n(13),o=n(11),a=n(9);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class l{async sendFormData(e){const t=this.getFetchUrl(this.productsUrl),n={method:this.productId?"PATCH":"PUT",headers:{"Content-Type":"application/json;charset=utf-8"},body:JSON.stringify(e)};await Object(a.a)(t,n);const i=this.productEditMode?"product-updated":"product-saved";this.element.dispatchEvent(new CustomEvent(i,{bubbles:!0,detail:event}))}showNotificationMessage(e,{duration:t=2e3,type:n}={}){new s.a(e,{duration:t,type:n}).show()}constructor(e,t="api/rest/products"){r(this,"element",void 0),r(this,"inputElement",void 0),r(this,"productData",null),r(this,"categories",null),r(this,"onFormSubmit",e=>{e.preventDefault();const{productForm:t,imageListContainer:n}=this.subElements,i=new FormData(t),s={},o=["title","description","subcategory","price","quantity","discount","status"],a=["price","quantity","discount","status"];for(let[e,t]of i)o.includes(e)&&(t=a.includes(e)?parseInt(t,10):t,s[e]=t);this.productEditMode&&(s.id=this.productId),s.images=[];const r=n.querySelectorAll(".sortable-table__cell-img");for(const e of r){const{alt:t,src:n}=e;s.images.push({url:n,source:t})}this.sendFormData(s)}),r(this,"uploadImage",async()=>{const[e]=this.inputElement.files;if(!e)return;const t=new FormData;t.append("image",e);const{lastElementChild:n}=this.subElements["sortable-list-container"];let i;n.classList.add("is-loading");try{i=await Object(a.a)("https://api.imgur.com/3/image",{method:"POST",headers:{Authorization:"Client-ID ".concat("28aaa2e823b03b1")},body:t}),this.showNotificationMessage("Image upload succeeded!",{type:"success"}),this.appendUploadedImageToSortableList(e,i)}catch(e){this.showNotificationMessage("Upload to the server failed! Please try again later! ".concat(e),{type:"error",duration:3e3})}finally{n.classList.remove("is-loading")}}),r(this,"appendUploadedImageToSortableList",(e,t)=>{const{name:n}=e,{link:s}=t.data,{firstElementChild:o}=this.subElements.imageListContainer,a=[{url:s,source:n}].map(({url:e,source:t})=>this.getImageItem(e,t)),r=new i.a({items:a});o.append(r.element)}),r(this,"onUploadImageButtonClick",e=>{e.preventDefault();const t=document.createElement("div");t.innerHTML='<input type="file" accept="image/*" hidden="">',this.inputElement=t.firstElementChild,document.body.append(this.inputElement),this.inputElement.onchange=this.uploadImage,this.inputElement.click()}),this.productId=e,this.productEditMode=Boolean(this.productId),this.productsUrl=t,this.categoriesUrl="api/rest/categories"}async render(){const e=document.createElement("div");[this.categories,this.productData]=await this.getAllData(this.productEditMode),this.productEditMode?e.innerHTML=this.getEditProductFormTemplate(this.productData,this.categories):e.innerHTML=this.getCreateProductFormTemplate(this.categories);const t=e.firstElementChild;return this.element=t,this.subElements=this.getSubElements(),this.createImagesList(),this.initEventListeners(),this.element}initEventListeners(){this.subElements["sortable-list-container"].lastElementChild.addEventListener("click",this.onUploadImageButtonClick),this.element.addEventListener("submit",this.onFormSubmit)}async getAllData(e){const t=[this.getSingleData(this.categoriesUrl,{_sort:"weight",_refs:"subcategory"})];if(e){const e=this.getSingleData(this.productsUrl,{id:this.productId});t.push(e)}return await Promise.all(t)}async getSingleData(e,t){const n=this.getFetchUrl(e,t);return await Object(a.a)(n)}getFetchUrl(e,t){const n=new URL(e,"https://course-js.javascript.ru/");if(t)for(let[e,i]of Object.entries(t))n.searchParams.set(e,i);return n}getSubElements(e=this.element){return[...e.querySelectorAll("[data-element]")].reduce((e,t)=>(e[t.dataset.element]=t,e),{})}getEditProductFormTemplate([e],t){return'\n      <div class="product-form">\n        <form data-element="productForm" class="form-grid">\n          '.concat(this.getTitleTemplate(e),"\n          ").concat(this.getDescriptionTemplate(e),"\n          ").concat(this.getSortableImageListContainerTemplate(),"\n          ").concat(this.getProductCategoriesTemplate(t,e),"\n          ").concat(this.getProductPriceDiscountTemplate(e),"\n          ").concat(this.getProductQuantityTemplate(e),"\n          ").concat(this.getProductStatusTemplate(e),'\n          <div class="form-buttons">\n            <button type="submit" name="save" class="button-primary-outline">\n              Сохранить товар\n            </button>\n          </div>\n        </form>\n      </div>\n    ')}getTitleTemplate({title:e}){return'\n      <div class="form-group form-group__half_left">\n        <fieldset>\n          <label class="form-label">Название товара</label>\n          <input required="" type="text" name="title" class="form-control" placeholder="Название товара" value="'.concat(Object(o.a)(e),'">\n        </fieldset>\n      </div>\n    ')}getDescriptionTemplate({description:e}){return'\n      <div class="form-group form-group__wide">\n        <label class="form-label">Описание</label>\n        <textarea required="" class="form-control" name="description" data-element="productDescription" placeholder="Описание товара">'.concat(Object(o.a)(e),'"</textarea>\n      </div>\n    ')}getSortableImageListContainerTemplate(){return'\n      <div class="form-group form-group__wide" data-element="sortable-list-container">\n        <label class="form-label">Фото</label>\n        <div data-element="imageListContainer">\n        </div>\n        <button type="button" name="uploadImage" class="button-primary-outline"><span>Загрузить</span></button>\n      </div>\n    '}getProductCategoriesTemplate(e,t){let n;return t&&({subcategory:n}=t),'\n      <div class="form-group form-group__half_left">\n        <label class="form-label">Категория</label>\n        <select class="form-control" name="subcategory">\n        '.concat(e.map(({title:e,subcategories:t})=>t.map(({id:t,title:i})=>"\n                  <option ".concat(n&&n===t?"selected":"",' value="').concat(t,'">').concat(e," &gt; ").concat(i,"</option>\n                "))).join(""),"\n        </select>\n      </div>\n    ")}getProductPriceDiscountTemplate({price:e,discount:t}){return'\n      <div class="form-group form-group__half_left form-group__two-col">\n        <fieldset>\n          <label class="form-label">Цена ($)</label>\n          <input required="" type="number" name="price" class="form-control" placeholder="100" value="'.concat(e,'">\n        </fieldset>\n        <fieldset>\n          <label class="form-label">Скидка ($)</label>\n          <input required="" type="number" name="discount" class="form-control" placeholder="0" value="').concat(t,'">\n        </fieldset>\n      </div>\n    ')}getProductQuantityTemplate({quantity:e}){return'\n      <div class="form-group form-group__part-half">\n        <label class="form-label">Количество</label>\n        <input required="" type="number" class="form-control" name="quantity" placeholder="1" value="'.concat(e,'">\n      </div>\n    ')}getProductStatusTemplate({status:e}){return'\n      <div class="form-group form-group__part-half">\n        <label class="form-label">Статус</label>\n        <select class="form-control" name="status">\n          <option '.concat(1===e?"selected":"",' value="1">Активен</option>\n          <option ').concat(0===e?"selected":"",' value="0">Неактивен</option>\n        </select>\n      </div>\n    ')}createImagesList(){if(!this.productData)return;const{imageListContainer:e}=this.subElements,[t]=this.productData,{images:n}=t,s=n.map(({url:e,source:t})=>this.getImageItem(e,t)),o=new i.a({items:s});e.append(o.element)}getImageItem(e,t){const n=document.createElement("div");return n.innerHTML='\n      <li class="products-edit__imagelist-item sortable-list__item">\n        <span>\n          <img src="/icon-grab.svg" data-grab-handle alt="grab">\n          <img class="sortable-table__cell-img" alt="'.concat(Object(o.a)(t),'" src="').concat(Object(o.a)(e),'">\n          <span>').concat(Object(o.a)(t),'</span>\n        </span>\n        <button type="button">\n          <img src="/icon-trash.svg" alt="delete" data-delete-handle>\n        </button>\n      </li>'),n.firstElementChild}getCreateProductFormTemplate(e){return'\n      <div class="product-form">\n        <form data-element="productForm" class="form-grid">\n        <div class="form-group form-group__half_left">\n          <fieldset>\n            <label class="form-label">Название товара</label>\n            <input required="" type="text" name="title" class="form-control" placeholder="Название товара">\n          </fieldset>\n        </div>\n        <div class="form-group form-group__wide">\n          <label class="form-label">Описание</label>\n          <textarea required="" class="form-control" name="description" data-element="productDescription" placeholder="Описание товара"></textarea>\n        </div>\n        <div class="form-group form-group__wide" data-element="sortable-list-container">\n          <label class="form-label">Фото</label>\n          <div data-element="imageListContainer"><ul class="sortable-list"></ul></div>\n          <button type="button" name="uploadImage" class="button-primary-outline fit-content"><span>Загрузить</span></button>\n        </div>\n        '.concat(this.getProductCategoriesTemplate(e),'\n        <div class="form-group form-group__half_left form-group__two-col">\n          <fieldset>\n            <label class="form-label">Цена ($)</label>\n            <input required="" type="number" name="price" class="form-control" placeholder="100">\n          </fieldset>\n          <fieldset>\n            <label class="form-label">Скидка ($)</label>\n            <input required="" type="number" name="discount" class="form-control" placeholder="0">\n          </fieldset>\n        </div>\n        <div class="form-group form-group__part-half">\n          <label class="form-label">Количество</label>\n          <input required="" type="number" class="form-control" name="quantity" placeholder="1">\n        </div>\n        <div class="form-group form-group__part-half">\n          <label class="form-label">Статус</label>\n          <select class="form-control" name="status">\n            <option value="1">Активен</option>\n            <option value="0">Неактивен</option>\n          </select>\n        </div>\n        <div class="form-buttons">\n          <button type="submit" name="save" class="button-primary-outline">\n            Добавить товар\n          </button>\n        </div>\n      </form>\n      </div>\n    ')}remove(){this.element.remove()}destroy(){this.remove(),this.subElements={}}}function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class d{constructor(e){c(this,"element",void 0),c(this,"subElements",{}),c(this,"components",{}),this.match=e}async initComponents(){const[,e]=this.match,t=new l(e);await t.render(),this.components.productForm=t}get template(){return'\n    <div class="products-edit">\n      <div class="content__top-panel">\n        <h1 class="page-title">\n          <a href="/products" class="link">Товары</a> / Добавить\n        </h1>\n      </div>\n      <div class="content-box">\n        <div data-element="productForm">\n          \x3c!-- product-form component --\x3e\n        </div>\n      </div>\n    </div>'}async render(){const e=document.createElement("div");return e.innerHTML=this.template,this.element=e.firstElementChild,this.subElements=this.getSubElements(this.element),await this.initComponents(),this.renderComponents(),this.element}renderComponents(){Object.keys(this.components).forEach(e=>{const t=this.subElements[e],{element:n}=this.components[e];t.append(n)})}getSubElements(e){return[...e.querySelectorAll("[data-element]")].reduce((e,t)=>(e[t.dataset.element]=t,e),{})}destroy(){for(const e of Object.values(this.components))e.destroy()}}},,function(e,t,n){"use strict";t.a=async function(e,t){let n,s;try{n=await fetch(e.toString(),t)}catch(e){throw new i(n,"Network error has occurred.")}if(!n.ok){let e=n.statusText;try{s=await n.json(),e=s.error&&s.error.message||s.data&&s.data.error&&s.data.error.message||e}catch(e){}let t="Error ".concat(n.status,": ").concat(e);throw new i(n,s,t)}try{return await n.json()}catch(e){throw new i(n,null,e.message)}};class i extends Error{constructor(e,t,n){var i,s,o;super(n),o="FetchError",(s="name")in(i=this)?Object.defineProperty(i,s,{value:o,enumerable:!0,configurable:!0,writable:!0}):i[s]=o,this.response=e,this.body=t}}window.addEventListener("unhandledrejection",e=>{e.reason instanceof i&&alert(e.reason.message)})},,function(e,t,n){"use strict";t.a=e=>e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},function(e,t,n){"use strict";function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,"a",(function(){return s}));class s{constructor({items:e=[]}={}){i(this,"element",void 0),i(this,"onDocumentPointerMove",({clientX:e,clientY:t})=>{this.moveDraggingAt(e,t);const{firstElementChild:n,children:i}=this.element,{top:s}=n.getBoundingClientRect(),{bottom:o}=this.element.getBoundingClientRect();if(t<s)this.movePlaceholderAt(0);else if(t>o)this.movePlaceholderAt(i.length);else for(let e=0;e<i.length;e++){const n=i[e];if(n!==this.draggingElem){const{top:i,bottom:s}=n.getBoundingClientRect(),{offsetHeight:o}=n;if(t>i&&t<s){if(t<i+o/2){this.movePlaceholderAt(e);break}this.movePlaceholderAt(e+1);break}}}this.scrollIfCloseToWindowEdge(t)}),i(this,"onDocumentPointerUp",()=>{this.dragStop()}),this.items=e,this.render()}render(){this.element=document.createElement("ul"),this.element.className="sortable-list",this.addItems(),this.initEventListeners()}initEventListeners(){this.element.addEventListener("pointerdown",e=>this.onPointerDown(e))}addItems(){for(let e of this.items)e.classList.add("sortable-list__item");this.element.append(...this.items)}onPointerDown(e){if(1!==e.which)return!1;const t=e.target.closest(".sortable-list__item");t&&(e.target.closest("[data-grab-handle]")&&(e.preventDefault(),this.dragStart(t,e)),e.target.closest("[data-delete-handle]")&&(e.preventDefault(),t.remove()))}dragStart(e,{clientX:t,clientY:n}){this.elementInitialIndex=[...this.element.children].indexOf(e),this.pointerInitialShift={x:t-e.getBoundingClientRect().x,y:n-e.getBoundingClientRect().y},this.draggingElem=e,this.placeholderElem=document.createElement("li"),this.placeholderElem.className="sortable-list__placeholder",e.style.width="".concat(e.offsetWidth,"px"),e.style.height="".concat(e.offsetHeight,"px"),this.placeholderElem.style.width=e.style.width,this.placeholderElem.style.height=e.style.height,e.classList.add("sortable-list__item_dragging"),e.after(this.placeholderElem),this.element.append(e),this.moveDraggingAt(t,n),document.addEventListener("pointermove",this.onDocumentPointerMove),document.addEventListener("pointerup",this.onDocumentPointerUp)}moveDraggingAt(e,t){this.draggingElem.style.left=e-this.pointerInitialShift.x+"px",this.draggingElem.style.top=t-this.pointerInitialShift.y+"px"}scrollIfCloseToWindowEdge(e){e<20?window.scrollBy(0,-10):e>document.documentElement.clientHeight-20&&window.scrollBy(0,10)}movePlaceholderAt(e){const t=this.element.children[e];t!==this.placeholderElem&&this.element.insertBefore(this.placeholderElem,t)}dragStop(){const e=[...this.element.children].indexOf(this.placeholderElem);this.placeholderElem.replaceWith(this.draggingElem),this.draggingElem.classList.remove("sortable-list__item_dragging"),this.draggingElem.style.left="",this.draggingElem.style.top="",this.draggingElem.style.width="",this.draggingElem.style.height="",document.removeEventListener("pointermove",this.onDocumentPointerMove),document.removeEventListener("pointerup",this.onDocumentPointerUp),this.draggingElem=null,e!==this.elementInitialIndex&&this.element.dispatchEvent(new CustomEvent("sortable-list-reorder",{bubbles:!0,detail:{from:this.elementInitialIndex,to:e}}))}remove(){this.element.remove(),document.removeEventListener("pointermove",this.onDocumentPointerMove),document.removeEventListener("pointerup",this.onDocumentPointerUp)}destroy(){this.remove()}}},function(e,t,n){"use strict";function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,"a",(function(){return s}));class s{constructor(e,{duration:t,type:n}={}){i(this,"element",void 0),this.message=e,this.duration=t,this.type=n,this.render()}get template(){return'\n      <div class="notification notification_'.concat(this.type,' show" style="--value:').concat(this.duration/1e3,'s">\n        <div class="notification__content">\n          ').concat(this.message,"\n        </div>\n      </div>\n    ")}render(){s.activeComponent&&s.activeComponent.remove();const e=document.createElement("div");e.innerHTML=this.template,this.element=e.firstElementChild,s.activeComponent=this.element}show(e=document.body){e.append(this.element),setTimeout(()=>{this.remove()},this.duration)}remove(){this.element.remove()}destroy(){this.remove()}}i(s,"activeComponent",void 0)}]]);
//# sourceMappingURL=products-edit-index-js-4.js.map