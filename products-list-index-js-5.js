(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{10:function(t,e,s){"use strict";s.d(e,"a",(function(){return r}));var n=s(9);function i(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class r{constructor(t=[],{url:e="",sorted:s={id:t.find(t=>t.sortable).id,order:"asc"},isSortLocally:n=!1,step:r=20,start:a=1,end:o=a+r,from:l=null,to:d=null,filtered:c=null}={}){i(this,"element",void 0),i(this,"subElements",{}),i(this,"data",[]),i(this,"loading",!1),i(this,"step",20),i(this,"start",1),i(this,"end",this.start+this.step),i(this,"onWindowScroll",async()=>{const{bottom:t}=this.element.getBoundingClientRect(),{id:e,order:s}=this.sorted;if(t<document.documentElement.clientHeight&&!this.loading&&!this.isSortLocally){this.start=this.end,this.end=this.start+this.step,this.loading=!0;const t=await this.loadData(e,s,this.start,this.end);this.update(t),this.loading=!1}}),i(this,"onSortClick",t=>{const e=t.target.closest('[data-sortable="true"]');if(e){const{id:t,order:s}=e.dataset,n=(t=>({asc:"desc",desc:"asc"}[t]))(s);this.sorted={id:t,order:n},e.dataset.order=n,e.append(this.subElements.arrow),this.isSortLocally?this.sortLocally(t,n):(this.start=1,this.end=1+this.step,this.sortOnServer(t,n,this.start,this.end))}}),this.headersConfig=t,this.url=new URL(e,"https://course-js.javascript.ru/"),this.sorted=s,this.isSortLocally=n,this.step=r,this.start=a,this.end=o,this.from=l,this.to=d,this.filtered=c,this.render()}async render(){const{id:t,order:e}=this.sorted,s=document.createElement("div");s.innerHTML=this.getTable();const n=s.firstElementChild;this.element=n,this.subElements=this.getSubElements(n);const i=await this.loadData(t,e,this.start,this.end);return this.renderRows(i),this.initEventListeners(),this.element}async loadData(t,e,s=this.start,i=this.end){if(this.from&&this.to&&(this.url.searchParams.set("createdAt_gte",this.from),this.url.searchParams.set("createdAt_lte",this.to)),this.filtered){const{price_gte:t,price_lte:e,title_like:s,status:n}=this.filtered;this.url.searchParams.set("price_gte",t),this.url.searchParams.set("price_lte",e),s&&this.url.searchParams.set("title_like",s),n&&this.url.searchParams.set("status",n)}this.url.searchParams.set("_sort",t),this.url.searchParams.set("_order",e),this.url.searchParams.set("_start",s),this.url.searchParams.set("_end",i),this.element.classList.add("sortable-table_loading");const r=await Object(n.a)(this.url);return this.element.classList.remove("sortable-table_loading"),r}addRows(t){this.data=t,this.subElements.body.innerHTML=this.getTableRows(t),t.length?this.element.classList.remove("sortable-table_empty"):this.element.classList.add("sortable-table_empty")}update(t){const e=document.createElement("div");return this.data=[...this.data,...t],e.innerHTML=this.getTableRows(t),this.subElements.body.append(...e.childNodes),e}getTableHeader(){return'<div data-element="header" class="sortable-table__header sortable-table__row">\n      '.concat(this.headersConfig.map(t=>this.getHeaderRow(t)).join(""),"\n    </div>")}getHeaderRow({id:t,title:e,sortable:s}){const n=this.sorted.id===t?this.sorted.order:"asc";return'\n      <div class="sortable-table__cell" data-id="'.concat(t,'" data-sortable="').concat(s,'" data-order="').concat(n,'">\n        <span>').concat(e,"</span>\n        ").concat(this.getHeaderSortingArrow(t),"\n      </div>\n    ")}getHeaderSortingArrow(t){return(this.sorted.id===t?this.sorted.order:"")?'<span data-element="arrow" class="sortable-table__sort-arrow">\n          <span class="sort-arrow"></span>\n        </span>':""}getTableBody(t){return'\n      <div data-element="body" class="sortable-table__body">\n        '.concat(this.getTableRows(t),"\n      </div>")}getTableRows(t){return t.map(e=>'\n      <a href="/products/'.concat(e.id,'" class="sortable-table__row">\n        ').concat(this.getTableRow(e,t),"\n      </a>")).join("")}getTableRow(t){return this.headersConfig.map(({id:t,template:e})=>({id:t,template:e})).map(({id:e,template:s})=>s?s(t[e]):'<div class="sortable-table__cell">'.concat(t[e],"</div>")).join("")}getTable(){return'\n      <div class="sortable-table">\n        '.concat(this.getTableHeader(),"\n        ").concat(this.getTableBody(this.data),'\n\n        <div data-element="loading" class="loading-line sortable-table__loading-line"></div>\n\n        <div data-element="emptyPlaceholder" class="sortable-table__empty-placeholder">\n          No data\n        </div>\n      </div>')}initEventListeners(){this.subElements.header.addEventListener("pointerdown",this.onSortClick),document.addEventListener("scroll",this.onWindowScroll)}sortLocally(t,e){const s=this.sortData(t,e);this.subElements.body.innerHTML=this.getTableBody(s)}async sortOnServer(t,e,s,n){const i=await this.loadData(t,e,s,n);this.renderRows(i)}renderRows(t){t.length?(this.element.classList.remove("sortable-table_empty"),this.addRows(t)):this.element.classList.add("sortable-table_empty")}sortData(t,e){const s=[...this.data],n=this.headersConfig.find(e=>e.id===t),{sortType:i,customSorting:r}=n,a="asc"===e?1:-1;return s.sort((e,s)=>{switch(i){case"number":return a*(e[t]-s[t]);case"string":return a*e[t].localeCompare(s[t],"ru");case"custom":return a*r(e,s);default:return a*(e[t]-s[t])}})}getSubElements(t){return[...t.querySelectorAll("[data-element]")].reduce((t,e)=>(t[e.dataset.element]=e,t),{})}remove(){this.element.remove(),document.removeEventListener("scroll",this.onWindowScroll)}destroy(){this.remove(),this.subElements={}}}},4:function(t,e,s){"use strict";s.r(e),s.d(e,"default",(function(){return h}));var n=s(10);function i(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class r{constructor({min:t=100,max:e=200,formatValue:s=(t=>"$"+t),selected:n={from:t,to:e}}={}){i(this,"element",void 0),i(this,"subElements",{}),i(this,"onThumbPointerMove",t=>{t.preventDefault();const{thumbLeft:e,thumbRight:s,inner:n,progress:i,from:r,to:a}=this.subElements,{left:o,right:l,width:d}=n.getBoundingClientRect();if(this.dragging===e){let e=(t.clientX-o+this.shiftX)/d;e<0&&(e=0),e*=100;const n=parseFloat(s.style.right);e+n>100&&(e=100-n),this.dragging.style.left="".concat(e,"%"),i.style.left="".concat(e,"%"),r.innerHTML=this.formatValue(this.getValue().from)}else{let e=(l-t.clientX-this.shiftX)/d;e<0&&(e=0),e*=100;let s=parseFloat(this.subElements.thumbLeft.style.left);s+e>100&&(e=100-s),this.dragging.style.right="".concat(e,"%"),i.style.right="".concat(e,"%"),a.innerHTML=this.formatValue(this.getValue().to)}}),i(this,"onThumbPointerUp",()=>{this.element.classList.remove("range-slider_dragging"),document.removeEventListener("pointermove",this.onThumbPointerMove),document.removeEventListener("pointerup",this.onThumbPointerUp),this.element.dispatchEvent(new CustomEvent("range-select",{detail:this.getValue(),bubbles:!0}))}),this.min=t,this.max=e,this.originalMin=this.min,this.originalMax=this.max,this.formatValue=s,this.selected=n,this.render()}get template(){const{from:t,to:e}=this.selected;return'<div class="range-slider">\n      <span data-element="from">'.concat(this.formatValue(t),'</span>\n      <div data-element="inner" class="range-slider__inner">\n        <span data-element="progress" class="range-slider__progress"></span>\n        <span data-element="thumbLeft" class="range-slider__thumb-left"></span>\n        <span data-element="thumbRight" class="range-slider__thumb-right"></span>\n      </div>\n      <span data-element="to">').concat(this.formatValue(e),"</span>\n    </div>")}render(){const t=document.createElement("div");t.innerHTML=this.template,this.element=t.firstElementChild,this.element.ondragstart=()=>!1,this.subElements=this.getSubElements(t),this.initEventListeners(),this.update()}initEventListeners(){const{thumbLeft:t,thumbRight:e}=this.subElements;t.addEventListener("pointerdown",t=>this.onThumbPointerDown(t)),e.addEventListener("pointerdown",t=>this.onThumbPointerDown(t))}getSubElements(t){return[...t.querySelectorAll("[data-element]")].reduce((t,e)=>(t[e.dataset.element]=e,t),{})}remove(){this.element.remove()}destroy(){this.remove(),document.removeEventListener("pointermove",this.onThumbPointerMove),document.removeEventListener("pointerup",this.onThumbPointerUp)}update(){const{progress:t,thumbLeft:e,thumbRight:s}=this.subElements,n=this.max-this.min,i=Math.floor((this.selected.from-this.min)/n*100)+"%",r=Math.floor((this.max-this.selected.to)/n*100)+"%";t.style.left=i,t.style.right=r,e.style.left=i,s.style.right=r}reset(){const{from:t,to:e}=this.subElements;this.min=this.originalMin,this.selected.from=this.originalMin,t.innerHTML=this.formatValue(this.originalMin),this.max=this.originalMax,this.selected.to=this.originalMax,e.innerHTML=this.formatValue(this.originalMax),this.update()}onThumbPointerDown(t){const e=t.target;t.preventDefault();const{left:s,right:n}=e.getBoundingClientRect();e===this.subElements.thumbLeft?this.shiftX=n-t.clientX:this.shiftX=s-t.clientX,this.dragging=e,this.element.classList.add("range-slider_dragging"),document.addEventListener("pointermove",this.onThumbPointerMove),document.addEventListener("pointerup",this.onThumbPointerUp)}getValue(){const{thumbLeft:t,thumbRight:e}=this.subElements,s=this.max-this.min,{left:n}=t.style,{right:i}=e.style;return{from:Math.round(this.min+.01*parseFloat(n)*s),to:Math.round(this.max-.01*parseFloat(i)*s)}}}function a(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class o{constructor({sliderMin:t=0,sliderMax:e=4e3}={}){a(this,"element",void 0),a(this,"subElements",{}),a(this,"components",{}),this.sliderMin=t,this.sliderMax=e,this.render()}initComponents(){const t=new r({min:this.sliderMin,max:this.sliderMax});this.components.doubleSlider=t}get template(){return'\n    <div class="content-box content-box_small">\n      <form class="form-inline">\n        <div class="form-group">\n          <label class="form-label">Сортировать по:</label>\n          <input type="text" data-element="filterName" class="form-control" placeholder="Название товара">\n        </div>\n      <div data-element="doubleSlider">\n        \x3c!-- double-slider component --\x3e\n      </div>\n      <div class="form-group">\n        <label class="form-label">Статус:</label>\n        <select class="form-control" data-element="filterStatus">\n          <option value="" selected="">Любой</option>\n          <option value="1">Активный</option>\n          <option value="0">Неактивный</option>\n        </select>\n      </div>\n    </form>\n  </div>'}render(){const t=document.createElement("div");return t.innerHTML=this.template,this.element=t.firstElementChild,this.subElements=this.getSubElements(this.element),this.initComponents(),this.renderComponents(),this.element}renderComponents(){Object.keys(this.components).forEach(t=>{const e=this.subElements[t],{element:s}=this.components[t];e.append(s)})}getSubElements(t){return[...t.querySelectorAll("[data-element]")].reduce((t,e)=>(t[e.dataset.element]=e,t),{})}destroy(){for(const t of Object.values(this.components))t.destroy()}}var l=[{id:"images",title:"Image",sortable:!1,template:t=>'\n          <div class="sortable-table__cell">\n            <img class="sortable-table-image" alt="Image" src="'.concat(t[0]?t[0].url:"",'">\n          </div>\n        ')},{id:"title",title:"Name",sortable:!0,sortType:"string"},{id:"subcategory",title:"Subcategory",sortable:!1,template:t=>'\n        <div class="sortable-table__cell">\n          '.concat(t.category&&t.title?'<span data-tooltip=\n              "\n                <div class=&quot;sortable-table-tooltip&quot;>\n                  <span class=&quot;sortable-table-tooltip__category&quot;>'.concat(t.category?t.category.title:"","</span> /\n                  <b class=&quot;sortable-table-tooltip__subcategory&quot;>").concat(t.title,'</b>\n                </div>\n              ">\n                ').concat(t.title,"\n              </span> "):"-","\n        </div>\n        ")},{id:"quantity",title:"Quantity",sortable:!0,sortType:"number"},{id:"price",title:"Price",sortable:!0,sortType:"number",template:t=>'<div class="sortable-table__cell">$'.concat(t,"</div>")},{id:"status",title:"Status",sortable:!0,sortType:"number",template:t=>'<div class="sortable-table__cell">\n          '.concat(t>0?"Active":"Inactive","\n        </div>")}],d=s(9);function c(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class h{constructor(){c(this,"element",void 0),c(this,"subElements",{}),c(this,"components",{}),c(this,"sliderOriginalFrom",0),c(this,"sliderOriginalTo",4e3),c(this,"sliderFrom",this.sliderOriginalFrom),c(this,"sliderTo",this.sliderOriginalTo),c(this,"filterProducts",async t=>{const{type:e,detail:s}=t;if("range-select"===e){const{from:t,to:e}=s;this.sliderFrom=t,this.sliderTo=e}this.components.sortableTable.start=1,this.components.sortableTable.end=1+this.components.sortableTable.step;const{sorted:n,start:i,end:r,element:a}=this.components.sortableTable,{id:o,order:l}=n;a.classList.add("sortable-table_loading");const{subElements:c}=this.components.sortPanel,{filterName:h,filterStatus:m}=c,{value:u}=h,{value:b}=m,p=new URL("api/rest/products","https://course-js.javascript.ru/");p.searchParams.set("price_gte",this.sliderFrom),p.searchParams.set("price_lte",this.sliderTo),u&&p.searchParams.set("title_like",u),b&&p.searchParams.set("status",b),p.searchParams.set("_sort",o),p.searchParams.set("_order",l),p.searchParams.set("_start",i),p.searchParams.set("_end",r),this.components.sortableTable.filtered={price_gte:this.sliderFrom,price_lte:this.sliderTo,title_like:u,status:b};const g=await Object(d.a)(p);this.components.sortableTable.addRows(g),a.classList.remove("sortable-table_loading")}),c(this,"resetFilters",t=>{t.preventDefault();const{subElements:e,components:s}=this.components.sortPanel,{filterName:n,filterStatus:i}=e,{doubleSlider:r}=s;n.value="",i.value="",this.sliderFrom=this.sliderOriginalFrom,this.sliderTo=this.sliderOriginalTo,r.reset(),this.filterProducts(t)})}async initComponents(){const t=new Date,e=(new Date(t.getTime()-2592e6),new o({sliderMin:this.sliderFrom,sliderMax:this.sliderTo})),s=new n.a(l,{url:"api/rest/products?_embed=subcategory.category&_sort=title&_order=asc&_start=0&_end=30"});this.components.sortPanel=e,this.components.sortableTable=s}get template(){return'\n    <div class="products-list">\n      <div class="content__top-panel">\n        <h1 class="page-title">Товары</h1>\n        <a href="/products/add" class="button-primary">Добавить товар</a>\n      </div>\n      <div data-element="sortPanel">\n        \x3c!-- sort-panel component --\x3e\n      </div>\n      <div data-element="sortableTable">\n        \x3c!-- sortable-table component --\x3e\n      </div>\n    </div>'}async render(){const t=document.createElement("div");return t.innerHTML=this.template,this.element=t.firstElementChild,this.subElements=this.getSubElements(this.element),await this.initComponents(),this.renderComponents(),this.modifyEmptyPlaceholder(),this.initEventListeners(),this.element}initEventListeners(){const{subElements:t}=this.components.sortPanel,{filterName:e,filterStatus:s}=t,n=this.element.querySelector(".button-primary-outline");for(const t of[e,s])t.addEventListener("input",this.filterProducts);n.addEventListener("click",this.resetFilters),this.element.addEventListener("range-select",this.filterProducts)}removeEventListeners(){const{subElements:t}=this.components.sortPanel,{filterName:e,filterStatus:s}=t,n=this.element.querySelector(".button-primary-outline");for(const t of[e,s])t.removeEventListener("input",this.filterProducts);n.removeEventListener("click",this.resetFilters),this.element.removeEventListener("range-select",this.filterProducts)}modifyEmptyPlaceholder(){const{subElements:t}=this.components.sortableTable,{emptyPlaceholder:e}=t;e.innerHTML='\n      <div>\n        <p>Не найдено товаров удовлетворяющих выбранному критерию</p>\n        <button type="button" class="button-primary-outline">Очистить фильтры</button>\n      </div>\n    '}renderComponents(){Object.keys(this.components).forEach(t=>{const e=this.subElements[t],{element:s}=this.components[t];e.append(s)})}getSubElements(t){return[...t.querySelectorAll("[data-element]")].reduce((t,e)=>(t[e.dataset.element]=e,t),{})}destroy(){this.removeEventListeners();for(const t of Object.values(this.components))t.destroy()}}},9:function(t,e,s){"use strict";e.a=async function(t,e){let s,i;try{s=await fetch(t.toString(),e)}catch(t){throw new n(s,"Network error has occurred.")}if(!s.ok){let t=s.statusText;try{i=await s.json(),t=i.error&&i.error.message||i.data&&i.data.error&&i.data.error.message||t}catch(t){}let e="Error ".concat(s.status,": ").concat(t);throw new n(s,i,e)}try{return await s.json()}catch(t){throw new n(s,null,t.message)}};class n extends Error{constructor(t,e,s){var n,i,r;super(s),r="FetchError",(i="name")in(n=this)?Object.defineProperty(n,i,{value:r,enumerable:!0,configurable:!0,writable:!0}):n[i]=r,this.response=t,this.body=e}}window.addEventListener("unhandledrejection",t=>{t.reason instanceof n&&alert(t.reason.message)})}}]);
//# sourceMappingURL=products-list-index-js-5.js.map